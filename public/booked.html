<!DOCTYPE html>
<html>
<head>
  <title>My Bookings</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ede9fe, #f5f3ff);
      min-height: 100vh;
    }

    nav {
      background: #7c3aed;
      padding: 15px 30px;
    }

    nav a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
      font-weight: bold;
    }

    .card {
      max-width: 600px;
      margin: 60px auto;
      background: white;
      padding: 40px;
      border-radius: 18px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    h2 {
      color: #5b21b6;
      text-align: center;
      margin-bottom: 25px;
    }

    .booking {
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-bottom: 15px;
      background: #fafafa;
    }

    .cancel-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<nav>
  <a href="/home.html">Home</a>
  <a href="/book.html">Book</a>
  <a href="/booked.html">My Bookings</a>
  <a href="#" onclick="logout()">Logout</a>
</nav>

<div class="card">
  <h2>My Bookings</h2>
  <div id="bookings"></div>
</div>

<script>
/* ðŸ” AUTH */
if (localStorage.getItem("role") !== "user") {
  localStorage.clear();
  location.href = "/user-login.html";
}

function logout() {
  localStorage.clear();
  location.href = "/role.html";
}

const container = document.getElementById("bookings");

/* ðŸ”„ LOAD BOOKINGS */
function loadBookings() {
  const username = localStorage.getItem("username");

  fetch(`https://smart-booking-backend.vercel.app/api/bookings?username=${username}`)
    .then(res => res.json())
    .then(data => {
      container.innerHTML = "";

      // âœ… FILTER: show only active bookings
      const active = data.filter(b => b.is_booked !== false);

      if (active.length === 0) {
        container.innerHTML = "<p>No bookings found</p>";
        return;
      }

      active.forEach(b => {
        const div = document.createElement("div");
        div.className = "booking";

        div.innerHTML = `
          <p><b>Time:</b> ${b.time}</p>
          <p><b>Date:</b> ${new Date(b.booking_date).toDateString()}</p>
          <button onclick="cancelBooking(${b.id})"
            style="
              background:#dc2626;
              color:white;
              border:none;
              padding:10px;
              border-radius:8px;
              cursor:pointer;
            ">
            Cancel Booking
          </button>
        `;

        container.appendChild(div);
      });
    });
}

/* âŒ CANCEL BOOKING */
function cancelBooking(id) {
  if (!confirm("Are you sure you want to cancel this booking?")) return;

  fetch("https://smart-booking-backend.vercel.app/api/cancel", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ booking_id: id })
  })
  .then(res => res.json())
  .then(() => {
    alert("Booking cancelled successfully");
    location.reload(); // âœ… FORCE REFRESH
  });
}
loadBookings();
</script>

</body>
</html>