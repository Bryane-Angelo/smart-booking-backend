<script>
/* ðŸ”’ AUTH */
if (localStorage.getItem("role") !== "user") {
  localStorage.clear();
  location.href = "/user-login.html";
}

function logout() {
  localStorage.clear();
  location.href = "/role.html";
}

/* DATE SETUP */
const dateInput = document.getElementById("date");
const today = new Date().toISOString().split("T")[0];
dateInput.min = today;
dateInput.value = today;

/* LOAD SLOTS FOR A GIVEN DATE */
function loadSlots(forDate) {
  fetch(`https://smart-booking-backend.vercel.app/api/slots?date=${forDate}`)
    .then(res => res.json())
    .then(data => {
      const slots = document.getElementById("slots");
      slots.innerHTML = "";

      if (!data || data.length === 0) {
        const opt = document.createElement("option");
        opt.text = "No slots available";
        slots.appendChild(opt);
        return;
      }

      data.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.text = s.time + (s.is_booked ? " (Booked)" : "");
        opt.disabled = s.is_booked;
        slots.appendChild(opt);
      });
    });
}

/* LOAD TODAY SLOTS ON PAGE LOAD */
loadSlots(today);

/* LOAD WHEN DATE CHANGES */
dateInput.addEventListener("change", () => {
  loadSlots(dateInput.value);
});

/* BOOK SLOT */
function book() {
  const slotId = document.getElementById("slots").value;

  if (!slotId || slotId === "No slots available") {
    alert("Please select a valid slot");
    return;
  }

  fetch("https://smart-booking-backend.vercel.app/api/book", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      slot_id: slotId,
      username: localStorage.getItem("username")
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    loadSlots(dateInput.value);
  });
}
</script>